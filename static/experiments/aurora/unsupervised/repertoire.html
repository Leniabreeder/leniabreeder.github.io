<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">

	<title>AURORA repertoire unsupervised</title>

	<style>
		body { margin: 0; overflow: hidden; }
		video {
			display: none;
			position: absolute;
			width: 256;
			height: 256;
			pointer-events: none;
		}
		.video-border {
			border: 1px solid white;
		}
	</style>

	<script type="importmap">
		{
			"imports": {
				"three": "https://unpkg.com/three@0.150.0/build/three.module.js",
				"three/examples/jsm/controls/OrbitControls.js": "https://unpkg.com/three@0.150.0/examples/jsm/controls/OrbitControls.js"
			}
		}
	</script>
</head>

<body>
	<video id="hoverVideo" loop></video>
	<script type="module">
		import * as THREE from 'three';
		import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

		const scene = new THREE.Scene();
		const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
		const renderer = new THREE.WebGLRenderer();
		renderer.setSize(window.innerWidth, window.innerHeight);
		document.body.appendChild(renderer.domElement);

		const controls = new OrbitControls(camera, renderer.domElement);
		controls.enableDamping = true;
		controls.dampingFactor = 0.1;
		controls.rotateSpeed = 1.0;
		controls.zoomSpeed = 1.2;
		controls.panSpeed = 0.8;
		controls.maxPolarAngle = Math.PI;
		controls.minPolarAngle = 0;

		const planes = [];
		const videoElement = document.getElementById('hoverVideo');
		const raycaster = new THREE.Raycaster();
		const mouse = new THREE.Vector2();

		async function loadPoints() {
			const response = await fetch('descriptors_3d.json');
			const pointsData = await response.json();
			const loader = new THREE.TextureLoader();

			pointsData.forEach((position, i) => {
				loader.load(`./phenotype_medium/${i.toString().padStart(4, '0')}.png`, (texture) => {
					const canvas = document.createElement('canvas');
					const context = canvas.getContext('2d');
					canvas.width = texture.image.width;
					canvas.height = texture.image.height;
					context.drawImage(texture.image, 0, 0);

					const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
					const data = imageData.data;

					for (let j = 0; j < data.length; j += 4) {
						if (data[j] === 0 && data[j + 1] === 0 && data[j + 2] === 0) {
							data[j + 3] = 0; // Set alpha to 0 for black pixels
						}
					}

					context.putImageData(imageData, 0, 0);
					const processedTexture = new THREE.CanvasTexture(canvas);

					const material = new THREE.MeshBasicMaterial({ map: processedTexture, transparent: true });
					const plane = new THREE.Mesh(new THREE.PlaneGeometry(0.64, 0.64), material);
					plane.position.set(position[0], position[1], position[2]);
					plane.userData.videoSrc = `./video/${i.toString().padStart(4, '0')}.mp4`;
					planes.push(plane);
					scene.add(plane);
				});
			});
		}

		loadPoints();

		camera.position.set(0, 1, 50);

		function animate() {
			requestAnimationFrame(animate);
			planes.forEach(plane => plane.lookAt(camera.position));
			controls.update();
			renderer.render(scene, camera);
		}

		animate();

		window.addEventListener('resize', () => {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
		});

		window.addEventListener('mousemove', (event) => {
			mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
			mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

			videoElement.style.left = `${event.clientX + 20}px`;
			videoElement.style.top = `${event.clientY + 20}px`;
		});

		window.addEventListener('dblclick', () => {
			raycaster.setFromCamera(mouse, camera);
			const intersects = raycaster.intersectObjects(planes);

			if (intersects.length > 0) {
				const intersectedPlane = intersects[0].object;
				videoElement.src = intersectedPlane.userData.videoSrc;
				videoElement.style.display = 'block';
				videoElement.onloadeddata = () => {
					videoElement.classList.add('video-border');
					videoElement.play();
				};
			} else {
				videoElement.classList.remove('video-border');
				videoElement.style.display = 'none';
				videoElement.pause();
			}
		});
	</script>
</body>
</html>
